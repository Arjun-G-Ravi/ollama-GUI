<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Studio</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ¦™</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .prose pre { background-color: #111827 !important; padding: 1rem; border-radius: 0.5rem; border: 1px solid #374151; position: relative; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose code { color: #e5e7eb; background-color: #374151; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875em; }
        .prose pre code { background-color: transparent; padding: 0; color: inherit; }
        .prose table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9rem; }
        .prose th, .prose td { border: 1px solid #4b5563; padding: 0.5rem; text-align: left; }
        .prose th { background-color: #374151; }
        
        .copy-btn {
            position: absolute; top: 0.5rem; right: 0.5rem;
            background: #374151; color: #9ca3af;
            padding: 0.2rem 0.5rem; border-radius: 0.25rem;
            font-size: 0.75rem; cursor: pointer; border: 1px solid #4b5563;
        }
        .copy-btn:hover { background: #4b5563; color: white; }

        .model-card { transition: all 0.2s; }
        .model-card:hover { transform: translateY(-2px); border-color: #10b981; }
        .model-card.selected { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }

        details.thinking-box {
            background-color: #1f2937;
            border-left: 3px solid #60a5fa;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        details.thinking-box summary {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.75rem;
            color: #9ca3af;
            font-weight: bold;
            text-transform: uppercase;
            user-select: none;
            transition: color 0.2s;
            background: rgba(0,0,0,0.2);
        }
        details.thinking-box summary:hover { color: #e5e7eb; background: rgba(0,0,0,0.3); }
        details.thinking-box .thinking-content {
            padding: 1rem;
            font-size: 0.85rem;
            color: #9ca3af;
            border-top: 1px solid #374151;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Image Preview Styles */
        .image-preview-container {
            display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;
        }
        .image-preview-item {
            position: relative; width: 60px; height: 60px; border-radius: 0.5rem; overflow: hidden; border: 1px solid #4b5563;
        }
        .image-preview-item img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .image-preview-item .remove-btn {
            position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.7); color: white;
            width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;
            font-size: 10px; cursor: pointer;
        }
        
        /* Generation Settings Panel */
        .gen-settings-panel {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        .gen-settings-panel label {
            font-size: 0.7rem;
            color: #9ca3af;
            text-transform: uppercase;
            font-weight: 600;
        }
        .gen-settings-panel input, .gen-settings-panel select {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.375rem;
            color: white;
            padding: 0.5rem;
            font-size: 0.875rem;
            width: 100%;
        }
        .gen-settings-panel input:focus, .gen-settings-panel select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        /* Generated Media Display */
        .generated-media-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
        }
        .generated-image {
            max-width: 100%;
            max-height: 512px;
            border-radius: 0.5rem;
            border: 2px solid #3b82f6;
        }
        .generated-video {
            max-width: 100%;
            max-height: 512px;
            border-radius: 0.5rem;
            border: 2px solid #8b5cf6;
        }
        .progress-bar-container {
            width: 100%;
            max-width: 400px;
            background: #374151;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 8px;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
        }
        
        /* Mode indicator */
        .mode-badge {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            text-transform: uppercase;
            font-weight: 700;
        }
        .mode-badge.text { background: #1d4ed8; color: white; }
        .mode-badge.image-gen { background: #7c3aed; color: white; }
        .mode-badge.video-gen { background: #dc2626; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Top Bar -->
    <div class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shrink-0 shadow-md z-10">
        <div class="flex items-center gap-6">
            <h1 class="text-xl font-bold text-blue-400 tracking-tight cursor-pointer hover:text-blue-300 transition" onclick="newChat()" title="Start New Chat"><i class="fa-solid fa-layer-group mr-2"></i>Ollama Studio</h1>
            
            <div id="connectionStatus" class="flex items-center gap-2 text-xs font-mono bg-gray-900 px-3 py-1 rounded border border-gray-600">
                <div class="w-2 h-2 rounded-full bg-red-500" id="statusDot"></div>
                <span id="statusText" class="text-gray-400">Checking...</span>
            </div>

            <div class="flex gap-3">
                <div class="bg-gray-900 border border-gray-600 rounded px-3 py-1 flex flex-col justify-center w-36">
                    <div class="flex justify-between text-[10px] text-gray-400 uppercase font-bold"><span>CPU</span> <span>RAM</span></div>
                    <div class="flex justify-between items-center text-xs font-mono text-green-400 gap-2">
                        <span id="stat-cpu">0%</span> <span id="stat-ram">0 / 0 GB</span>
                    </div>
                </div>
                <div class="bg-gray-900 border border-gray-600 rounded px-3 py-1 flex flex-col justify-center w-36">
                    <div class="flex justify-between text-[10px] text-gray-400 uppercase font-bold"><span>GPU</span> <span>VRAM</span></div>
                    <div class="flex justify-between items-center text-xs font-mono text-purple-400 gap-2">
                        <span id="stat-gpu">0%</span> <span id="stat-vram">0 / 0 GB</span>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 border border-gray-600 rounded px-3 py-2 flex items-center gap-2" title="Total Tokens Used">
                <i class="fa-solid fa-coins text-yellow-500 text-xs"></i>
                <span id="totalTokens" class="text-xs font-mono font-bold text-gray-200">0</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="openModelModal()" id="modelBtn" class="bg-gray-700 hover:bg-gray-600 border border-gray-600 text-gray-200 px-4 py-1.5 rounded text-sm flex items-center gap-2 transition">
                <span id="currentModelName">Select Model</span>
                <i class="fa-solid fa-chevron-down text-xs"></i>
            </button>
            <button onclick="newChat()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-1.5 rounded text-sm border border-gray-600 transition" title="Start New Chat">
                <i class="fa-solid fa-plus mr-1"></i> New Chat
            </button>
            <button onclick="restartServer()" class="bg-orange-900/40 hover:bg-orange-900/80 text-orange-300 px-3 py-1.5 rounded text-sm border border-orange-800 transition" title="Restart Ollama Server">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>
    </div>

    <!-- Model Modal -->
    <div id="modelModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-800 border border-gray-700 rounded-xl w-3/4 max-w-5xl h-3/4 flex flex-col shadow-2xl">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-bold text-white"><i class="fa-solid fa-box-open mr-2"></i>Available Models</h2>
                <div class="flex gap-2">
                    <button onclick="fetchModels()" class="text-sm text-blue-400 hover:text-blue-300 mr-4"><i class="fa-solid fa-rotate"></i> Refresh</button>
                    <button onclick="closeModelModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
            </div>
            <div id="modelModalContent" class="p-6 overflow-y-auto space-y-8">
                <!-- Sections injected here -->
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">
        <div class="w-72 bg-gray-800 border-r border-gray-700 flex flex-col shrink-0">
            <div class="flex border-b border-gray-700">
                <button onclick="switchTab('prompts')" id="tab-prompts" class="flex-1 py-3 text-sm font-semibold bg-gray-700 text-blue-400 border-b-2 border-blue-400">Prompts</button>
                <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-3 text-sm font-semibold text-gray-400 hover:bg-gray-700 border-b-2 border-transparent">History</button>
            </div>
            <div id="panel-prompts" class="flex-1 overflow-y-auto p-3 space-y-2">
                <button onclick="createNewPrompt()" class="w-full border border-dashed border-gray-600 text-gray-400 p-2 rounded text-xs hover:border-blue-500 hover:text-blue-400 transition mb-2">+ New Prompt</button>
                <div id="promptsList" class="space-y-2"></div>
            </div>
            <div id="panel-history" class="flex-1 overflow-y-auto p-3 space-y-2 hidden">
                <button onclick="clearHistory()" class="text-xs text-red-400 hover:underline w-full text-right mb-2">Clear All</button>
                <div id="historyList" class="space-y-2"></div>
            </div>
            <div class="p-3 border-t border-gray-700 bg-gray-900/30">
                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">System Prompt</label>
                <div id="activeSystemPromptName" class="text-sm font-semibold text-blue-400 truncate">Default</div>
                <p id="activeSystemPromptPreview" class="text-xs text-gray-500 truncate opacity-70">You are a helpful assistant.</p>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-gray-900 relative">
            <div id="chatWindow" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth pb-32">
            </div>
            <div class="p-4 bg-gray-800 border-t border-gray-700 absolute bottom-0 w-full">
                <div class="max-w-4xl mx-auto relative">
                    <div id="loadingIndicator" class="hidden absolute -top-8 left-0 text-xs text-blue-400 flex items-center gap-2">
                        <i class="fa-solid fa-circle-notch fa-spin"></i> <span id="loadingText">Generating...</span>
                    </div>
                    
                    <!-- Mode Badge -->
                    <div class="flex items-center gap-2 mb-2">
                        <span id="currentModeBadge" class="mode-badge text">ðŸ’¬ Text</span>
                    </div>
                    
                    <!-- Generation Settings Panel (for Image/Video Gen) -->
                    <div id="genSettingsPanel" class="gen-settings-panel hidden">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                            <div>
                                <label>Width</label>
                                <select id="genWidth">
                                    <option value="256">256</option>
                                    <option value="512" selected>512</option>
                                    <option value="768">768</option>
                                    <option value="1024">1024</option>
                                </select>
                            </div>
                            <div>
                                <label>Height</label>
                                <select id="genHeight">
                                    <option value="256">256</option>
                                    <option value="512" selected>512</option>
                                    <option value="768">768</option>
                                    <option value="1024">1024</option>
                                </select>
                            </div>
                            <div>
                                <label>Steps</label>
                                <input type="number" id="genSteps" value="30" min="1" max="150">
                            </div>
                            <div>
                                <label>Guidance</label>
                                <input type="number" id="genGuidance" value="7.5" min="0" max="20" step="0.5">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label>Negative Prompt</label>
                                <input type="text" id="genNegPrompt" placeholder="blurry, low quality...">
                            </div>
                            <div>
                                <label>Seed (-1 = random)</label>
                                <input type="number" id="genSeed" value="-1" min="-1">
                            </div>
                        </div>
                        <div id="videoSettings" class="grid grid-cols-2 gap-3 hidden">
                            <div>
                                <label>Frames</label>
                                <input type="number" id="genFrames" value="16" min="4" max="64">
                            </div>
                            <div>
                                <label>FPS</label>
                                <input type="number" id="genFps" value="8" min="1" max="30">
                            </div>
                        </div>
                    </div>

                    <!-- Image Preview Area -->
                    <div id="imagePreviewArea" class="image-preview-container"></div>

                    <div class="relative">
                        <!-- Attachment Button -->
                        <button onclick="document.getElementById('fileInput').click()" class="absolute left-2 top-2.5 text-gray-400 hover:text-white p-1 rounded transition" title="Attach Image">
                            <i class="fa-solid fa-paperclip"></i>
                        </button>
                        <input type="file" id="fileInput" accept="image/*" multiple class="hidden" onchange="handleFileSelect(event)">

                        <textarea id="userInput" rows="1" placeholder="Type a message (or paste/drop image)..." 
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-12 py-3 focus:outline-none focus:border-blue-500 resize-none overflow-hidden shadow-inner text-sm"
                            style="min-height: 50px; max-height: 200px;"></textarea>
                        
                        <button onclick="handleMainButton()" id="sendBtn" class="absolute right-2 bottom-2 bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-md transition shadow-lg">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversationHistory = [];
        let currentConversationId = null;
        let currentSystemPrompt = "You are a helpful assistant.";
        let selectedModel = null;
        let isGenerating = false;
        let totalTokensUsed = 0;
        let isOllamaOnline = false;
        let favoriteModels = [];
        let abortController = null;
        let currentImages = []; // Stores base64 strings
        let currentThinkingBox = null; // Reference to current thinking message box
        let isInThinkingMode = false; // Track if we're currently processing thinking tags
        
        // HuggingFace / Generation Mode variables
        let currentModelType = 'text'; // 'text', 'image-gen', 'video-gen'
        let currentModelBackend = 'ollama'; // 'ollama', 'huggingface'
        let customModelCards = {}; // Store custom model cards
        let currentGenParams = {
            width: 512,
            height: 512,
            steps: 30,
            guidance_scale: 7.5,
            negative_prompt: '',
            seed: -1,
            num_frames: 16,
            fps: 8
        };
        let currentTaskId = null; // For HF generation tracking

        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            fetchPrompts();
            fetchHistory();
            fetchFavorites();
            fetchCustomCards(); // Fetch custom model cards on load
            loadDefaultModel(); // Auto-select default model
            setInterval(updateStats, 500);
            setInterval(checkHealth, 5000);
            
            const tx = document.getElementById('userInput');
            tx.addEventListener("input", function(){ this.style.height = "auto"; this.style.height = (this.scrollHeight) + "px"; });
            tx.addEventListener("keydown", function(e){ if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleMainButton(); } });
            
            // Paste and Drop Listeners
            tx.addEventListener('paste', handlePaste);
            tx.addEventListener('drop', handleDrop);
            tx.addEventListener('dragover', (e) => e.preventDefault());
        });
        
        // --- Fetch Custom Cards ---
        async function fetchCustomCards() {
            try {
                const res = await fetch('/api/custom_cards');
                customModelCards = await res.json();
            } catch(e) {
                console.error('Failed to fetch custom cards:', e);
            }
        }

        // --- Image Handling ---
        function handleFileSelect(e) {
            const files = e.target.files;
            processFiles(files);
            e.target.value = ''; // Reset
        }

        function handleDrop(e) {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0) processFiles(files);
        }

        function handlePaste(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            const files = [];
            for (let item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    files.push(item.getAsFile());
                }
            }
            if (files.length > 0) {
                e.preventDefault();
                processFiles(files);
            }
        }

        function processFiles(files) {
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    currentImages.push(base64);
                    renderImagePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderImagePreview() {
            const container = document.getElementById('imagePreviewArea');
            container.innerHTML = '';
            currentImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'image-preview-item';
                div.innerHTML = `
                    <img src="${img}">
                    <div class="remove-btn" onclick="removeImage(${index})"><i class="fa-solid fa-xmark"></i></div>
                `;
                container.appendChild(div);
            });
        }

        function removeImage(index) {
            currentImages.splice(index, 1);
            renderImagePreview();
        }

        // --- Core Logic ---

        async function checkHealth() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                if(data.status === 'online') {
                    isOllamaOnline = true;
                    dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.8)]";
                    text.innerText = "Online"; text.className = "text-green-400";
                } else {
                    isOllamaOnline = false;
                    dot.className = "w-2 h-2 rounded-full bg-red-500 shadow-[0_0_5px_rgba(239,68,68,0.8)]";
                    text.innerText = "Offline"; text.className = "text-red-400";
                }
            } catch(e) { isOllamaOnline = false; }
        }

        async function restartServer() {
            if(!confirm("Restart Ollama Server?")) return;
            document.getElementById('statusText').innerText = "Restarting...";
            try { await fetch('/api/restart', {method: 'POST'}); } catch(e) {}
        }

        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                document.getElementById('stat-cpu').innerText = data.cpu + '%';
                document.getElementById('stat-ram').innerText = data.ram_text;
                document.getElementById('stat-gpu').innerText = data.gpu + '%';
                document.getElementById('stat-vram').innerText = data.vram_text;
                document.getElementById('totalTokens').innerText = totalTokensUsed.toLocaleString();
            } catch(e) {}
        }

        // --- Favorites ---
        async function fetchFavorites() {
            const res = await fetch('/api/favorites');
            favoriteModels = await res.json();
        }

        async function toggleFavorite(e, name) {
            e.stopPropagation();
            await fetch('/api/favorites', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name})
            });
            await fetchFavorites();
            fetchModels();
        }

        // --- Models & Categories ---
        function openModelModal() {
            document.getElementById('modelModal').classList.remove('hidden');
            fetchModels();
        }
        function closeModelModal() { document.getElementById('modelModal').classList.add('hidden'); }

        async function loadDefaultModel() {
            try {
                const res = await fetch('/api/default_model');
                const data = await res.json();
                if (data.model) {
                    // Auto-select the default model
                    selectModel(data.model, data.model, 'text', 'ollama');
                }
            } catch (e) {
                console.error('Failed to load default model:', e);
            }
        }

        async function fetchModels() {
            const content = document.getElementById('modelModalContent');
            content.innerHTML = `<div class="text-center text-gray-500 py-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i><p>Fetching models...</p></div>`;
            
            try {
                const res = await fetch('/api/models');
                const data = await res.json();
                const customRes = await fetch('/api/custom_cards');
                const customData = await customRes.json();

                if(data.error) {
                    content.innerHTML = `<div class="text-center text-red-500">Ollama is offline. <button onclick="restartServer()" class="underline">Restart Server</button></div>`;
                    return;
                }

                // Categorize Models
                const categories = {
                    coding: [],
                    fast: [],
                    chat: [],
                    uncensored: [],
                    vision: [],
                    'image-gen': [],
                    'video-gen': []
                };

                // First, add Ollama models
                data.models.forEach(m => {
                    const custom = customData[m.name] || {};
                    const tags = (custom.tags || []).map(t => t.toLowerCase());
                    
                    // Priority Logic
                    if (tags.includes('coding') || tags.includes('dev') || m.name.includes('coder')) {
                        categories.coding.push(m);
                    } else if (tags.includes('uncensored')) {
                        categories.uncensored.push(m);
                    } else if (tags.includes('fast') || tags.includes('speed') || tags.includes('light')) {
                        categories.fast.push(m);
                    } else {
                        categories.chat.push(m);
                    }
                });

                // Add HuggingFace models from custom cards
                Object.keys(customData).forEach(modelId => {
                    const card = customData[modelId];
                    if (card.backend === 'huggingface') {
                        const modelType = card.model_type || 'image-gen';
                        const pseudoModel = {
                            name: modelId,
                            size: 0,
                            isHuggingFace: true
                        };
                        if (modelType === 'image-gen') {
                            categories['image-gen'].push(pseudoModel);
                        } else if (modelType === 'video-gen') {
                            categories['video-gen'].push(pseudoModel);
                        }
                    }
                });

                // Render Sections
                content.innerHTML = '';
                
                const renderSection = (title, models, icon) => {
                    if (models.length === 0) return;
                    
                    models.sort((a, b) => {
                        const favA = favoriteModels.includes(a.name);
                        const favB = favoriteModels.includes(b.name);
                        if (favA && !favB) return -1;
                        if (!favA && favB) return 1;
                        return a.name.localeCompare(b.name);
                    });

                    const sectionHtml = `
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-400 mb-3 border-b border-gray-700 pb-1 flex items-center gap-2">
                                <i class="fa-solid ${icon}"></i> ${title}
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${models.map(m => createCardHtml(m, customData[m.name] || {})).join('')}
                            </div>
                        </div>
                    `;
                    content.innerHTML += sectionHtml;
                };

                renderSection('ðŸŽ¨ Image Generation', categories['image-gen'], 'fa-image');
                renderSection('ðŸŽ¬ Video Generation', categories['video-gen'], 'fa-video');
                renderSection('Vision Models', categories.vision, 'fa-eye');
                renderSection('Chat & General Models', categories.chat, 'fa-comments');
                renderSection('Coding Models', categories.coding, 'fa-code');
                renderSection('Fast Models', categories.fast, 'fa-bolt');
                renderSection('Uncensored', categories.uncensored, 'fa-comments');
                
                data.models.forEach(m => fetchModelDetails(m.name, customData[m.name] || {}));

            } catch(e) { console.error(e); }
        }

        function createCardHtml(m, custom) {
            const isHuggingFace = m.isHuggingFace || custom.backend === 'huggingface';
            const sizeGB = isHuggingFace ? 'HF' : (m.size / (1024*1024*1024)).toFixed(1);
            const isSelected = selectedModel === m.name ? 'selected' : '';
            const isFav = favoriteModels.includes(m.name);
            
            // Custom Display Name Logic
            const displayName = custom.display_name || m.name;
            
            // Vision Badge Logic
            const visionBadge = custom.vision ? 
                `<span class="text-[10px] bg-purple-900/50 text-purple-200 px-1.5 py-0.5 rounded border border-purple-800 ml-2"><i class="fa-solid fa-eye mr-1"></i>Vision</span>` : '';
            
            // Reasoning Badge Logic
            const reasoningBadge = custom.reasoning ? 
                `<span class="text-[10px] bg-orange-900/50 text-orange-200 px-1.5 py-0.5 rounded border border-orange-800 ml-2"><i class="fa-solid fa-brain mr-1"></i>Reasoning</span>` : '';

            // HuggingFace / Model Type Badges
            const hfBadge = isHuggingFace ? 
                `<span class="text-[10px] bg-yellow-900/50 text-yellow-200 px-1.5 py-0.5 rounded border border-yellow-800 ml-2"><i class="fa-solid fa-face-smile mr-1"></i>HuggingFace</span>` : '';
            
            const imageGenBadge = custom.model_type === 'image-gen' ? 
                `<span class="text-[10px] bg-pink-900/50 text-pink-200 px-1.5 py-0.5 rounded border border-pink-800 ml-2"><i class="fa-solid fa-image mr-1"></i>Image Gen</span>` : '';
            
            const videoGenBadge = custom.model_type === 'video-gen' ? 
                `<span class="text-[10px] bg-red-900/50 text-red-200 px-1.5 py-0.5 rounded border border-red-800 ml-2"><i class="fa-solid fa-video mr-1"></i>Video Gen</span>` : '';

            const description = custom.description ? `<p class="text-xs text-gray-400 mt-2 italic line-clamp-2">${custom.description}</p>` : '';
            const tags = custom.tags ? `<div class="mt-2 flex flex-wrap gap-1">${custom.tags.map(t => `<span class="text-[10px] bg-blue-900/50 text-blue-200 px-1.5 py-0.5 rounded border border-blue-800">${t}</span>`).join('')}</div>` : '';
            
            // Icon logic based on model type
            let iconClass = 'fa-microchip';
            if (custom.tags) {
                if (custom.tags.includes('coding')) iconClass = 'fa-code';
                else if (custom.tags.includes('uncensored')) iconClass = 'fa-unlock';
                else if (custom.tags.includes('fast')) iconClass = 'fa-bolt';
                else if (custom.tags.includes('chat') || custom.tags.includes('reasoning')) iconClass = 'fa-brain';
            }
            if (custom.icon) iconClass = custom.icon; // Allow override
            
            // Different border colors based on model type
            let borderColor = 'border-blue-400';
            if (custom.model_type === 'image-gen') borderColor = 'border-pink-400';
            else if (custom.model_type === 'video-gen') borderColor = 'border-red-400';
            
            const speedVal = custom.speed ? custom.speed : 'N/A';
            const sizeDisplay = isHuggingFace ? 'HuggingFace' : `${sizeGB} GB`;
            const modelType = custom.model_type || 'text';
            const backend = custom.backend || 'ollama';

            // For HF models, show default params instead of loading specs
            const hfParamsHtml = isHuggingFace && custom.default_params ? `
                <div class="text-xs text-gray-500 space-y-1 mt-3 pt-2 border-t border-gray-600">
                    <div class="grid grid-cols-2 gap-2">
                        <div><span class="text-[10px] text-gray-500 uppercase">Size</span> <span class="text-pink-300 font-mono">${custom.default_params.width}x${custom.default_params.height}</span></div>
                        <div><span class="text-[10px] text-gray-500 uppercase">Steps</span> <span class="text-purple-300 font-mono">${custom.default_params.steps}</span></div>
                    </div>
                </div>` : '';

            return `
                <div class="model-card bg-gray-700 border ${borderColor} rounded-lg p-4 cursor-pointer relative ${isSelected}" onclick="selectModel('${m.name}', '${displayName}', '${modelType}', '${backend}')">
                    <div class="absolute top-2 right-2 z-10">
                        <button onclick="toggleFavorite(event, '${m.name}')" class="text-lg hover:scale-110 transition ${isFav ? 'text-yellow-400' : 'text-gray-600 hover:text-yellow-400'}">
                            <i class="fa-solid fa-star"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-start mb-1 pr-6">
                        <h3 class="font-bold text-white text-lg truncate w-full flex items-center gap-2">
                            <i class="fa-solid ${iconClass} text-xs opacity-50"></i> ${displayName}
                        </h3>
                    </div>
                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                        <span class="text-xs ${isHuggingFace ? 'bg-yellow-600' : 'bg-gray-600'} px-2 py-0.5 rounded text-gray-100">${sizeDisplay}</span>
                        ${visionBadge}
                        ${reasoningBadge}
                        ${imageGenBadge}
                        ${videoGenBadge}
                    </div>
                    ${description}
                    ${tags}
                    ${isHuggingFace ? hfParamsHtml : `
                    <div class="text-xs text-gray-500 space-y-1 mt-3 pt-2 border-t border-gray-600" id="details-${m.name.replace(/[:.]/g, '')}">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-circle-notch fa-spin"></i> <span>Loading specs...</span></div>
                    </div>
                    <div id="speed-data-${m.name.replace(/[:.]/g, '')}" class="hidden">${speedVal}</div>`}
                </div>
            `;
        }

        async function fetchModelDetails(name, custom) {
            try {
                const res = await fetch('/api/model_details', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name}) });
                const data = await res.json();
                const container = document.getElementById(`details-${name.replace(/[:.]/g, '')}`);
                const speedVal = document.getElementById(`speed-data-${name.replace(/[:.]/g, '')}`).innerText;

                if(data.details) {
                    container.innerHTML = `
                        <div class="grid grid-cols-2 gap-2">
                            <div><span class="text-[10px] text-gray-500 uppercase">Family</span> <span class="text-blue-300 font-mono">${data.details.family || 'N/A'}</span></div>
                            <div><span class="text-[10px] text-gray-500 uppercase">Quant</span> <span class="text-purple-300 font-mono">${data.details.quantization_level || 'N/A'}</span></div>
                            <div><span class="text-[10px] text-gray-500 uppercase">Params</span> <span class="text-green-300 font-mono">${data.details.parameter_size || 'N/A'}</span></div>
                            <div><span class="text-[10px] text-gray-500 uppercase">Speed</span> <span class="text-gray-300 font-mono">${speedVal}</span></div>
                        </div>`;
                }
            } catch(e) {}
        }

        function selectModel(name, displayName, modelType = 'text', backend = 'ollama') {
            selectedModel = name;
            currentModelType = modelType;
            currentModelBackend = backend;
            
            document.getElementById('currentModelName').innerText = displayName || name;
            closeModelModal();
            document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
            
            // Update UI based on model type
            updateGenerationUI();
            
            // Load default params for HF models
            if (backend === 'huggingface' && customModelCards[name]) {
                const defaultParams = customModelCards[name].default_params || {};
                currentGenParams = { ...currentGenParams, ...defaultParams };
                updateGenSettingsInputs();
            }
            
            // Preload the model into VRAM (only for Ollama models)
            if (backend === 'ollama') {
                preloadModel(name);
            }
        }
        
        function updateGenerationUI() {
            const genSettingsPanel = document.getElementById('genSettingsPanel');
            const modeBadge = document.getElementById('currentModeBadge');
            
            if (currentModelType === 'image-gen' || currentModelType === 'video-gen') {
                genSettingsPanel.classList.remove('hidden');
                
                // Update which settings are visible
                const videoSettings = document.getElementById('videoSettings');
                if (currentModelType === 'video-gen') {
                    videoSettings.classList.remove('hidden');
                    modeBadge.textContent = 'ðŸŽ¬ Video';
                    modeBadge.className = 'mode-badge video-gen';
                } else {
                    videoSettings.classList.add('hidden');
                    modeBadge.textContent = 'ðŸŽ¨ Image';
                    modeBadge.className = 'mode-badge image-gen';
                }
            } else {
                genSettingsPanel.classList.add('hidden');
                modeBadge.textContent = 'ðŸ’¬ Text';
                modeBadge.className = 'mode-badge text';
            }
        }
        
        function updateGenSettingsInputs() {
            document.getElementById('genWidth').value = currentGenParams.width || 512;
            document.getElementById('genHeight').value = currentGenParams.height || 512;
            document.getElementById('genSteps').value = currentGenParams.steps || 30;
            document.getElementById('genGuidance').value = currentGenParams.guidance_scale || 7.5;
            document.getElementById('genNegPrompt').value = currentGenParams.negative_prompt || '';
            document.getElementById('genSeed').value = currentGenParams.seed || -1;
            if (currentModelType === 'video-gen') {
                document.getElementById('genFrames').value = currentGenParams.num_frames || 16;
                document.getElementById('genFps').value = currentGenParams.fps || 8;
            }
        }
        
        function readGenSettings() {
            currentGenParams.width = parseInt(document.getElementById('genWidth').value) || 512;
            currentGenParams.height = parseInt(document.getElementById('genHeight').value) || 512;
            currentGenParams.steps = parseInt(document.getElementById('genSteps').value) || 30;
            currentGenParams.guidance_scale = parseFloat(document.getElementById('genGuidance').value) || 7.5;
            currentGenParams.negative_prompt = document.getElementById('genNegPrompt').value || '';
            currentGenParams.seed = parseInt(document.getElementById('genSeed').value) || -1;
            if (currentModelType === 'video-gen') {
                currentGenParams.num_frames = parseInt(document.getElementById('genFrames').value) || 16;
                currentGenParams.fps = parseInt(document.getElementById('genFps').value) || 8;
            }
        }
        
        async function preloadModel(modelName) {
            try {
                // Show loading message
                const loadingIndicator = document.getElementById('loadingIndicator');
                const loadingText = document.getElementById('loadingText');
                loadingIndicator.classList.remove('hidden');
                loadingText.innerText = 'Preloading model...';
                
                // Send a dummy request to load the model into memory
                await fetch('/api/preload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName })
                });
                
                // Hide loading message
                loadingIndicator.classList.add('hidden');
            } catch(e) {
                console.log('Preload failed:', e);
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        // --- Chat & Thinking Logic ---
        function handleMainButton() {
            if (isGenerating) {
                stopGeneration();
            } else {
                // Route to appropriate generation function based on model type
                if (currentModelBackend === 'huggingface') {
                    if (currentModelType === 'image-gen') {
                        generateImage();
                    } else if (currentModelType === 'video-gen') {
                        generateVideo();
                    } else {
                        sendMessage(); // Fallback
                    }
                } else {
                    sendMessage();
                }
            }
        }

        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            isGenerating = false;
            currentTaskId = null;
            document.getElementById('sendBtn').innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        // --- HuggingFace Image Generation ---
        async function generateImage() {
            if (isGenerating) return;
            if (!selectedModel) { alert("Select a model!"); openModelModal(); return; }
            
            const input = document.getElementById('userInput');
            const prompt = input.value.trim();
            
            if (!prompt) { alert("Enter a prompt for image generation!"); return; }

            input.value = ''; input.style.height = 'auto';
            isGenerating = true;
            
            document.getElementById('sendBtn').innerHTML = '<i class="fa-solid fa-stop"></i>';
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('loadingText').innerText = 'Starting image generation...';

            // Append user message
            appendMessage("user", `ðŸŽ¨ Generate image: "${prompt}"`);
            
            // Read current settings
            readGenSettings();
            
            const aiMsgDiv = appendMessage("assistant", ""); 
            const answerContent = aiMsgDiv.querySelector('.answer-content');
            const metaDiv = aiMsgDiv.querySelector('.msg-meta');
            
            try {
                // Start generation
                const startRes = await fetch('/api/hf/generate_image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: selectedModel,
                        prompt: prompt,
                        params: currentGenParams
                    })
                });
                
                const startData = await startRes.json();
                if (startData.error) throw new Error(startData.error);
                
                currentTaskId = startData.task_id;
                
                // Poll for status
                answerContent.innerHTML = `
                    <div class="generated-media-container">
                        <div class="text-center">
                            <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>
                            <p id="genStatusText" class="text-gray-400">Initializing...</p>
                            <div class="progress-bar-container mt-4">
                                <div id="genProgressBar" class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                await pollGenerationStatus(currentTaskId, answerContent, metaDiv, 'image');
                
            } catch (e) {
                answerContent.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
            }

            isGenerating = false;
            currentTaskId = null;
            document.getElementById('sendBtn').innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        // --- HuggingFace Video Generation ---
        async function generateVideo() {
            if (isGenerating) return;
            if (!selectedModel) { alert("Select a model!"); openModelModal(); return; }
            
            const input = document.getElementById('userInput');
            const prompt = input.value.trim();
            
            if (!prompt) { alert("Enter a prompt for video generation!"); return; }

            input.value = ''; input.style.height = 'auto';
            isGenerating = true;
            
            document.getElementById('sendBtn').innerHTML = '<i class="fa-solid fa-stop"></i>';
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('loadingText').innerText = 'Starting video generation...';

            // Append user message
            appendMessage("user", `ðŸŽ¬ Generate video: "${prompt}"`);
            
            // Read current settings
            readGenSettings();
            
            const aiMsgDiv = appendMessage("assistant", ""); 
            const answerContent = aiMsgDiv.querySelector('.answer-content');
            const metaDiv = aiMsgDiv.querySelector('.msg-meta');
            
            try {
                // Start generation
                const startRes = await fetch('/api/hf/generate_video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: selectedModel,
                        prompt: prompt,
                        params: currentGenParams
                    })
                });
                
                const startData = await startRes.json();
                if (startData.error) throw new Error(startData.error);
                
                currentTaskId = startData.task_id;
                
                // Poll for status
                answerContent.innerHTML = `
                    <div class="generated-media-container">
                        <div class="text-center">
                            <i class="fa-solid fa-spinner fa-spin text-4xl text-purple-400 mb-4"></i>
                            <p id="genStatusText" class="text-gray-400">Initializing...</p>
                            <div class="progress-bar-container mt-4">
                                <div id="genProgressBar" class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                await pollGenerationStatus(currentTaskId, answerContent, metaDiv, 'video');
                
            } catch (e) {
                answerContent.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
            }

            isGenerating = false;
            currentTaskId = null;
            document.getElementById('sendBtn').innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        // --- Poll HuggingFace Generation Status ---
        async function pollGenerationStatus(taskId, answerContent, metaDiv, mediaType) {
            const startTime = Date.now();
            
            while (isGenerating && currentTaskId === taskId) {
                try {
                    const res = await fetch(`/api/hf/status/${taskId}`);
                    const data = await res.json();
                    
                    if (data.status === 'not_found') {
                        answerContent.innerHTML = `<span class="text-red-400">Task not found</span>`;
                        return;
                    }
                    
                    // Update progress
                    const statusText = document.getElementById('genStatusText');
                    const progressBar = document.getElementById('genProgressBar');
                    if (statusText) statusText.textContent = data.message || data.status;
                    if (progressBar) progressBar.style.width = `${data.progress || 0}%`;
                    document.getElementById('loadingText').innerText = data.message || 'Generating...';
                    
                    if (data.status === 'completed') {
                        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                        metaDiv.innerText = `Generated in ${elapsed}s`;
                        
                        if (mediaType === 'image' && data.image_base64) {
                            answerContent.innerHTML = `
                                <div class="generated-media-container">
                                    <img src="data:image/png;base64,${data.image_base64}" class="generated-image" alt="Generated image">
                                    <div class="flex gap-2">
                                        <a href="/api/hf/download/${taskId}" download class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm">
                                            <i class="fa-solid fa-download mr-2"></i>Download
                                        </a>
                                    </div>
                                </div>
                            `;
                        } else if (mediaType === 'video') {
                            answerContent.innerHTML = `
                                <div class="generated-media-container">
                                    <video controls autoplay loop class="generated-video">
                                        <source src="/api/hf/download/${taskId}" type="video/mp4">
                                    </video>
                                    <div class="flex gap-2">
                                        <a href="/api/hf/download/${taskId}" download class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded text-sm">
                                            <i class="fa-solid fa-download mr-2"></i>Download
                                        </a>
                                    </div>
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    if (data.status === 'error') {
                        answerContent.innerHTML = `<span class="text-red-400">Generation failed: ${data.message}</span>`;
                        return;
                    }
                    
                    // Wait before next poll
                    await new Promise(r => setTimeout(r, 1000));
                    
                } catch (e) {
                    console.error('Poll error:', e);
                    await new Promise(r => setTimeout(r, 2000));
                }
            }
        }

        async function sendMessage() {
            if (isGenerating) return;
            if (!selectedModel) { alert("Select a model!"); openModelModal(); return; }
            if (!isOllamaOnline) { alert("Ollama is offline."); return; }
            
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            
            if (!text && currentImages.length === 0) return;

            input.value = ''; input.style.height = 'auto';
            isGenerating = true;
            abortController = new AbortController();

            document.getElementById('sendBtn').innerHTML = '<i class="fa-solid fa-stop"></i>';
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('loadingText').innerText = 'Loading model...';

            // Prepare Message
            const userMsg = { role: "user", content: text };
            
            // Handle Images for API (strip header)
            if (currentImages.length > 0) {
                userMsg.images = currentImages.map(img => img.split(',')[1]);
            }

            if (conversationHistory.length === 0) conversationHistory.push({ role: "system", content: currentSystemPrompt });
            conversationHistory.push(userMsg);
            
            // Append to UI (pass full base64 for display)
            appendMessage("user", text, currentImages);
            
            // Clear images
            currentImages = [];
            renderImagePreview();

            const aiMsgDiv = appendMessage("assistant", ""); 
            const thoughtContainer = aiMsgDiv.querySelector('.thought-container');
            const thoughtContent = aiMsgDiv.querySelector('.thought-content');
            const answerContent = aiMsgDiv.querySelector('.answer-content');
            const metaDiv = aiMsgDiv.querySelector('.msg-meta');
            
            let fullResponse = "";
            let inThinkTag = false;
            let currentThought = "";
            let currentAnswer = "";
            let hasStartedGenerating = false;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: selectedModel, messages: conversationHistory }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const json = JSON.parse(line);
                            if(json.error) throw new Error(json.error);

                            if (json.message && json.message.content) {
                                fullResponse += json.message.content;
                                
                                // Real-time thinking detection and display
                                let workingText = fullResponse;
                                const thinkStartIdx = workingText.indexOf('<think>');
                                const thinkEndIdx = workingText.indexOf('</think>');
                                
                                if (thinkStartIdx !== -1) {
                                    // We have a thinking section
                                    thoughtContainer.style.display = 'block';
                                    document.getElementById('loadingText').innerText = 'Thinking...';
                                    
                                    if (thinkEndIdx !== -1) {
                                        // Complete thinking block
                                        currentThought = workingText.substring(thinkStartIdx + 7, thinkEndIdx).trim();
                                        currentAnswer = workingText.substring(0, thinkStartIdx) + workingText.substring(thinkEndIdx + 8);
                                        inThinkTag = false;
                                        // Once thinking is done, switch to generating
                                        if (currentAnswer.trim()) {
                                            document.getElementById('loadingText').innerText = 'Generating...';
                                            hasStartedGenerating = true;
                                        }
                                    } else {
                                        // Still in thinking mode
                                        currentThought = workingText.substring(thinkStartIdx + 7).trim();
                                        currentAnswer = workingText.substring(0, thinkStartIdx);
                                        inThinkTag = true;
                                    }
                                    
                                    // Update thinking content with smaller italic style in real-time
                                    thoughtContent.textContent = currentThought;
                                    highlightCode(thoughtContent);
                                } else {
                                    // No thinking tags - just generating normally
                                    if (!hasStartedGenerating) {
                                        document.getElementById('loadingText').innerText = 'Generating...';
                                        hasStartedGenerating = true;
                                    }
                                    currentAnswer = workingText;
                                }

                                answerContent.innerHTML = marked.parse(currentAnswer.trim() || '...');
                                highlightCode(answerContent);
                                scrollToBottom();
                            }
                            
                            if (json.done) {
                                conversationHistory.push({ role: "assistant", content: fullResponse });
                                saveConversation(selectedModel);
                                if(json.eval_count) {
                                    const tps = (json.eval_count / (json.eval_duration / 1e9)).toFixed(1);
                                    const tokens = (json.prompt_eval_count || 0) + json.eval_count;
                                    totalTokensUsed += tokens;
                                    metaDiv.innerText = `${tokens} tokens | ${tps} T/s`;
                                }
                            }
                        } catch (e) {}
                    }
                }
            } catch (e) { 
                if (e.name === 'AbortError') {
                    answerContent.innerHTML += `<br><span class="text-yellow-500 text-xs">[Stopped by user]</span>`;
                } else {
                    answerContent.innerHTML += `<br><span class="text-red-400">Error: ${e.message}</span>`; 
                }
            }

            isGenerating = false;
            document.getElementById('sendBtn').innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
            document.getElementById('loadingIndicator').classList.add('hidden');
            abortController = null;
        }

        function splitThoughtAndAnswer(text) {
            const thinkMatch = text.match(/<think>([\s\S]*?)(?:<\/think>|$)/);
            const thought = thinkMatch ? thinkMatch[1] : null;
            const answer = text.replace(/<think>[\s\S]*?(?:<\/think>|$)/, '');
            return { thought, answer };
        }

        function appendMessage(role, text, images = []) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = isUser 
                ? "bg-blue-600 text-white px-4 py-2 rounded-2xl rounded-tr-none max-w-[85%] shadow-lg" 
                : "bg-gray-800 border border-gray-700 text-gray-200 px-5 py-4 rounded-2xl rounded-tl-none max-w-[90%] shadow-lg min-w-[200px]";
            
            let imgHtml = '';
            if (images && images.length > 0) {
                imgHtml = `<div class="flex gap-2 mb-2 flex-wrap">
                    ${images.map(img => `<img src="${img}" class="max-w-[200px] max-h-[200px] rounded border border-white/20">`).join('')}
                </div>`;
            }

            if (isUser) {
                bubble.innerHTML = `${imgHtml}<div class="msg-content prose prose-invert max-w-none text-sm leading-relaxed">${text}</div>`;
            } else {
                bubble.innerHTML = `
                    <details class="thought-container thinking-box" style="display: none;" open>
                        <summary>ðŸ’­ Thinking Process</summary>
                        <div class="thought-content" style="padding: 0.75rem; font-size: 0.85rem; font-style: italic; color: #d1d5db; background: rgba(0,0,0,0.3); border-radius: 0.25rem; margin-top: 0.5rem; white-space: pre-wrap; font-family: monospace;"></div>
                    </details>
                    <div class="answer-content prose prose-invert max-w-none text-sm leading-relaxed"><span class="animate-pulse">...</span></div>
                    <div class="msg-meta text-[10px] text-gray-500 mt-2 text-right font-mono h-4"></div>
                `;
            }
            div.appendChild(bubble);
            document.getElementById('chatWindow').appendChild(div);
            scrollToBottom();
            return bubble;
        }

        function highlightCode(element) {
            element.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            element.querySelectorAll('pre').forEach(pre => {
                if(pre.querySelector('.copy-btn')) return;
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.innerHTML = '<i class="fa-regular fa-copy"></i> Copy';
                btn.onclick = () => { navigator.clipboard.writeText(pre.querySelector('code').innerText); btn.innerHTML = 'Copied'; setTimeout(() => btn.innerHTML = 'Copy', 2000); };
                pre.appendChild(btn);
            });
        }

        function scrollToBottom() { const win = document.getElementById('chatWindow'); win.scrollTop = win.scrollHeight; }
        
        function newChat() {
            if(isGenerating) stopGeneration();
            conversationHistory = [];
            currentConversationId = null;
            totalTokensUsed = 0;
            currentImages = [];
            renderImagePreview();
            document.getElementById('totalTokens').innerText = "0";
            document.getElementById('chatWindow').innerHTML = '';
        }
        
        // --- History & Prompts ---
        async function saveConversation(model) {
            if(conversationHistory.length < 2) return;
            const res = await fetch('/api/history', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: currentConversationId, model: model, messages: conversationHistory }) });
            const data = await res.json(); currentConversationId = data.id; fetchHistory();
        }
        async function fetchHistory() {
            const res = await fetch('/api/history'); const history = await res.json();
            const list = document.getElementById('historyList'); list.innerHTML = '';
            history.forEach(h => {
                const div = document.createElement('div'); div.className = "bg-gray-700/30 p-2 rounded border border-gray-700 hover:bg-gray-700 cursor-pointer transition group";
                div.innerHTML = `<div class="text-[10px] text-blue-400 mb-1 flex justify-between"><span>${h.model}</span><span class="text-gray-500">${h.timestamp.split(' ')[1]}</span></div><div class="text-xs text-gray-300 truncate">${h.messages.find(m => m.role === 'user')?.content || "Empty"}</div>`;
                div.onclick = () => loadHistory(h); list.appendChild(div);
            });
        }
        function loadHistory(h) {
            currentConversationId = h.id; conversationHistory = h.messages; selectedModel = h.model; document.getElementById('currentModelName').innerText = h.model;
            const chatWin = document.getElementById('chatWindow'); chatWin.innerHTML = '';
            h.messages.forEach(msg => {
                if(msg.role === 'system') return;
                // Reconstruct images for display if they exist in history (Note: Ollama history doesn't always return the image data, but if we saved it locally it works)
                const imgs = msg.images ? msg.images.map(i => `data:image/png;base64,${i}`) : [];
                const bubble = appendMessage(msg.role, msg.content, imgs);
                if(msg.role === 'assistant') {
                    const parts = splitThoughtAndAnswer(msg.content);
                    const thoughtContainer = bubble.querySelector('.thought-container');
                    const thoughtContent = bubble.querySelector('.thought-content');
                    const answerContent = bubble.querySelector('.answer-content');
                    if(parts.thought) {
                        thoughtContainer.classList.remove('hidden');
                        thoughtContent.innerHTML = marked.parse(parts.thought);
                        highlightCode(thoughtContent);
                    }
                    answerContent.innerHTML = marked.parse(parts.answer);
                    highlightCode(answerContent);
                }
            });
        }
        async function fetchPrompts() {
            const res = await fetch('/api/prompts'); const prompts = await res.json();
            const list = document.getElementById('promptsList'); list.innerHTML = '';
            Object.keys(prompts).forEach(name => {
                const div = document.createElement('div'); div.className = "group flex items-center justify-between bg-gray-700/50 p-2 rounded border border-transparent hover:border-gray-600 cursor-pointer";
                div.innerHTML = `<div class="flex-1 truncate" onclick="setPrompt('${name}', '${prompts[name]}')"><div class="text-xs font-bold text-gray-300 group-hover:text-white">${name}</div></div><button onclick="deletePrompt('${name}')" class="text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash"></i></button>`;
                list.appendChild(div);
            });
        }
        async function createNewPrompt() { const name = prompt("Name:"); if(!name) return; const content = prompt("System Prompt:"); if(!content) return; await fetch('/api/prompts', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name, content}) }); fetchPrompts(); }
        async function deletePrompt(name) { if(confirm("Delete?")) { await fetch(`/api/prompts?name=${name}`, { method: 'DELETE' }); fetchPrompts(); } }
        function setPrompt(name, content) { currentSystemPrompt = content; document.getElementById('activeSystemPromptName').innerText = name; document.getElementById('activeSystemPromptPreview').innerText = content; newChat(); }
        async function clearHistory() { if(confirm("Clear all history?")) { await fetch('/api/history', { method: 'DELETE' }); fetchHistory(); } }
        function switchTab(tab) {
            document.getElementById('panel-prompts').classList.add('hidden'); document.getElementById('panel-history').classList.add('hidden');
            document.getElementById('tab-prompts').className = "flex-1 py-3 text-sm font-semibold text-gray-400 hover:bg-gray-700 border-b-2 border-transparent";
            document.getElementById('tab-history').className = "flex-1 py-3 text-sm font-semibold text-gray-400 hover:bg-gray-700 border-b-2 border-transparent";
            document.getElementById(`panel-${tab}`).classList.remove('hidden'); document.getElementById(`tab-${tab}`).className = "flex-1 py-3 text-sm font-semibold bg-gray-700 text-blue-400 border-b-2 border-blue-400";
        }
    </script>
</body>
</html>