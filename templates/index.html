<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local LLM Studio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked (Markdown Parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js (Code Coloring) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Markdown Styles */
        .prose pre { background-color: #111827 !important; padding: 1rem; border-radius: 0.5rem; border: 1px solid #374151; }
        .prose code { color: #e5e7eb; background-color: #374151; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875em; }
        .prose pre code { background-color: transparent; padding: 0; color: inherit; }
        .prose table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .prose th, .prose td { border: 1px solid #4b5563; padding: 0.5rem; text-align: left; }
        .prose th { background-color: #374151; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Top Bar: Stats & Controls -->
    <div class="h-14 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-bold text-blue-400"><i class="fa-solid fa-robot mr-2"></i>Local Studio</h1>
            
            <!-- Stats Widgets -->
            <div class="flex gap-3 text-xs font-mono">
                <div class="bg-gray-700 px-2 py-1 rounded border border-gray-600" title="CPU Usage">
                    <span class="text-gray-400">CPU:</span> <span id="stat-cpu" class="text-green-400">0%</span>
                </div>
                <div class="bg-gray-700 px-2 py-1 rounded border border-gray-600" title="RAM Usage">
                    <span class="text-gray-400">RAM:</span> <span id="stat-ram" class="text-yellow-400">0%</span> <span id="stat-ram-gb" class="text-gray-500 ml-1"></span>
                </div>
                <div class="bg-gray-700 px-2 py-1 rounded border border-gray-600 hidden" id="gpu-widget" title="GPU Usage">
                    <span class="text-gray-400">GPU:</span> <span id="stat-gpu" class="text-purple-400">0%</span>
                    <span class="text-gray-400 ml-2">VRAM:</span> <span id="stat-vram" class="text-purple-400">0%</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <select id="modelSelect" class="bg-gray-700 border border-gray-600 text-sm rounded px-2 py-1 outline-none focus:border-blue-500">
                <option>Loading models...</option>
            </select>
            <button onclick="resetConversation()" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-3 py-1 rounded text-sm border border-red-800 transition">
                <i class="fa-solid fa-trash-can mr-1"></i> Clear Context
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <div class="w-72 bg-gray-800 border-r border-gray-700 flex flex-col">
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-700">
                <button onclick="switchTab('prompts')" id="tab-prompts" class="flex-1 py-2 text-sm font-semibold bg-gray-700 text-blue-400">Prompts</button>
                <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 text-sm font-semibold text-gray-400 hover:bg-gray-700">History</button>
            </div>

            <!-- Prompts Panel -->
            <div id="panel-prompts" class="flex-1 overflow-y-auto p-3 space-y-2">
                <button onclick="createNewPrompt()" class="w-full border border-dashed border-gray-600 text-gray-400 p-2 rounded text-xs hover:border-blue-500 hover:text-blue-400 transition mb-2">
                    + Create New Prompt
                </button>
                <div id="promptsList" class="space-y-2"></div>
            </div>

            <!-- History Panel -->
            <div id="panel-history" class="flex-1 overflow-y-auto p-3 space-y-2 hidden">
                <button onclick="clearHistory()" class="text-xs text-red-400 hover:underline w-full text-right mb-2">Clear All</button>
                <div id="historyList" class="space-y-2"></div>
            </div>

            <!-- System Prompt Preview -->
            <div class="p-3 border-t border-gray-700 bg-gray-900/50">
                <label class="text-xs font-bold text-gray-500 uppercase">Active System Prompt</label>
                <div id="activeSystemPromptName" class="text-sm font-semibold text-blue-400 truncate">Default</div>
                <p id="activeSystemPromptPreview" class="text-xs text-gray-500 truncate">You are a helpful assistant.</p>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col bg-gray-900 relative">
            <!-- Chat Window -->
            <div id="chatWindow" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
                <!-- Welcome Message -->
                <div class="text-center text-gray-500 mt-20">
                    <i class="fa-solid fa-bolt text-4xl mb-4 opacity-20"></i>
                    <p>Select a model and start chatting.</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-gray-800 border-t border-gray-700">
                <div class="max-w-4xl mx-auto relative">
                    <textarea id="userInput" rows="1" placeholder="Type a message (Shift+Enter for new line)..." 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-4 pr-12 py-3 focus:outline-none focus:border-blue-500 resize-none overflow-hidden"
                        style="min-height: 50px; max-height: 200px;"></textarea>
                    <button onclick="sendMessage()" id="sendBtn" class="absolute right-2 bottom-2 bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-md transition">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let conversationHistory = []; // Current active conversation
        let currentSystemPrompt = "You are a helpful assistant.";
        let isGenerating = false;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchModels();
            fetchPrompts();
            fetchHistory();
            setInterval(updateStats, 2000); // Poll stats every 2s
            
            // Auto-resize textarea
            const tx = document.getElementById('userInput');
            tx.addEventListener("input", function(){
                this.style.height = "auto";
                this.style.height = (this.scrollHeight) + "px";
            });
            tx.addEventListener("keydown", function(e){
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // --- Stats Logic ---
        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                
                document.getElementById('stat-cpu').innerText = data.cpu + '%';
                document.getElementById('stat-ram').innerText = data.ram_percent + '%';
                document.getElementById('stat-ram-gb').innerText = `(${data.ram_text})`;

                if(data.gpu > 0 || data.vram_percent > 0) {
                    document.getElementById('gpu-widget').classList.remove('hidden');
                    document.getElementById('stat-gpu').innerText = data.gpu + '%';
                    document.getElementById('stat-vram').innerText = data.vram_percent + '%';
                }
            } catch(e) { console.error("Stats error", e); }
        }

        // --- Chat Logic ---
        async function sendMessage() {
            if (isGenerating) return;
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            const model = document.getElementById('modelSelect').value;

            if (!text) return;

            // UI Updates
            input.value = '';
            input.style.height = 'auto';
            isGenerating = true;
            document.getElementById('sendBtn').innerHTML = '<i class="fa-solid fa-circle-stop animate-pulse"></i>';

            // 1. Setup Context if empty
            if (conversationHistory.length === 0) {
                conversationHistory.push({ role: "system", content: currentSystemPrompt });
                // Remove welcome message if exists
                const chatWin = document.getElementById('chatWindow');
                if(chatWin.querySelector('.text-center')) chatWin.innerHTML = '';
            }

            // 2. Add User Message
            conversationHistory.push({ role: "user", content: text });
            appendMessage("user", text);

            // 3. Create AI Message Placeholder
            const aiMsgDiv = appendMessage("assistant", ""); 
            let fullResponse = "";

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        messages: conversationHistory
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const json = JSON.parse(line);
                            if (json.message && json.message.content) {
                                const content = json.message.content;
                                fullResponse += content;
                                // Render Markdown Live
                                aiMsgDiv.innerHTML = marked.parse(fullResponse);
                                // Highlight Code Blocks
                                aiMsgDiv.querySelectorAll('pre code').forEach((block) => {
                                    hljs.highlightElement(block);
                                });
                                scrollToBottom();
                            }
                            if (json.done) {
                                conversationHistory.push({ role: "assistant", content: fullResponse });
                                saveConversationToHistory(model);
                            }
                        } catch (e) { console.error("Parse error", e); }
                    }
                }

            } catch (e) {
                aiMsgDiv.innerHTML += `<br><span class="text-red-400">Error: ${e.message}</span>`;
            }

            isGenerating = false;
            document.getElementById('sendBtn').innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = isUser 
                ? "bg-blue-600 text-white px-4 py-2 rounded-2xl rounded-tr-none max-w-[80%]" 
                : "bg-gray-800 border border-gray-700 text-gray-200 px-6 py-4 rounded-2xl rounded-tl-none max-w-[90%] prose prose-invert";
            
            if(isUser) {
                bubble.innerText = text;
            } else {
                bubble.innerHTML = '<span class="animate-pulse">...</span>'; // Loading state
            }

            div.appendChild(bubble);
            document.getElementById('chatWindow').appendChild(div);
            scrollToBottom();
            return bubble;
        }

        function scrollToBottom() {
            const win = document.getElementById('chatWindow');
            win.scrollTop = win.scrollHeight;
        }

        function resetConversation() {
            conversationHistory = [];
            document.getElementById('chatWindow').innerHTML = `
                <div class="text-center text-gray-500 mt-20">
                    <i class="fa-solid fa-rotate-right text-4xl mb-4 opacity-20"></i>
                    <p>Context cleared. Start a new topic.</p>
                </div>`;
        }

        // --- Prompts Management ---
        async function fetchPrompts() {
            const res = await fetch('/api/prompts');
            const prompts = await res.json();
            const list = document.getElementById('promptsList');
            list.innerHTML = '';

            Object.keys(prompts).forEach(name => {
                const div = document.createElement('div');
                div.className = "group flex items-center justify-between bg-gray-700/50 p-2 rounded border border-transparent hover:border-gray-600";
                
                div.innerHTML = `
                    <div class="cursor-pointer flex-1 truncate" onclick="setPrompt('${name}', this)">
                        <div class="text-sm font-medium text-gray-300 group-hover:text-white">${name}</div>
                        <div class="text-xs text-gray-500 truncate">${prompts[name]}</div>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="editPrompt('${name}')" class="text-gray-400 hover:text-blue-400"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deletePrompt('${name}')" class="text-gray-400 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                // Store content in data attribute for easy access
                div.dataset.content = prompts[name];
                list.appendChild(div);
            });
        }

        async function createNewPrompt() {
            const name = prompt("Prompt Name:");
            if(!name) return;
            const content = prompt("System Instructions:");
            if(!content) return;
            
            await fetch('/api/prompts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, content})
            });
            fetchPrompts();
        }

        async function deletePrompt(name) {
            if(confirm(`Delete "${name}"?`)) {
                await fetch(`/api/prompts?name=${name}`, { method: 'DELETE' });
                fetchPrompts();
            }
        }

        async function editPrompt(name) {
            // Find current content
            const res = await fetch('/api/prompts');
            const data = await res.json();
            const newContent = prompt("Edit Instructions:", data[name]);
            if(newContent) {
                await fetch('/api/prompts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, content: newContent})
                });
                fetchPrompts();
            }
        }

        function setPrompt(name, el) {
            currentSystemPrompt = el.parentElement.dataset.content;
            document.getElementById('activeSystemPromptName').innerText = name;
            document.getElementById('activeSystemPromptPreview').innerText = currentSystemPrompt;
            resetConversation(); // Apply new persona immediately
        }

        // --- History Management ---
        async function saveConversationToHistory(model) {
            // Only save if it's a substantial conversation
            if(conversationHistory.length < 3) return; 
            
            await fetch('/api/history', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    model: model,
                    messages: conversationHistory
                })
            });
            fetchHistory();
        }

        async function fetchHistory() {
            const res = await fetch('/api/history');
            const history = await res.json();
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            history.forEach(h => {
                const div = document.createElement('div');
                div.className = "bg-gray-700/30 p-2 rounded border border-gray-700 hover:bg-gray-700 cursor-pointer transition";
                // Get first user message for title
                const firstUserMsg = h.messages.find(m => m.role === 'user')?.content || "Empty Chat";
                
                div.innerHTML = `
                    <div class="text-xs text-blue-400 mb-1 flex justify-between">
                        <span>${h.model}</span>
                        <span class="text-gray-500">${h.timestamp}</span>
                    </div>
                    <div class="text-sm text-gray-300 truncate">${firstUserMsg}</div>
                `;
                div.onclick = () => loadHistory(h.messages);
                list.appendChild(div);
            });
        }

        function loadHistory(messages) {
            conversationHistory = messages;
            const chatWin = document.getElementById('chatWindow');
            chatWin.innerHTML = '';
            
            messages.forEach(msg => {
                if(msg.role === 'system') return; // Don't show system prompt bubble
                const bubble = appendMessage(msg.role, "");
                if(msg.role === 'assistant') {
                    bubble.innerHTML = marked.parse(msg.content);
                    bubble.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                } else {
                    bubble.innerText = msg.content;
                }
            });
        }

        async function clearHistory() {
            if(confirm("Delete all chat history?")) {
                await fetch('/api/history', { method: 'DELETE' });
                fetchHistory();
            }
        }

        // --- Helpers ---
        async function fetchModels() {
            const res = await fetch('/api/models');
            const data = await res.json();
            const select = document.getElementById('modelSelect');
            select.innerHTML = '';
            data.models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name;
                opt.innerText = m.name;
                select.appendChild(opt);
            });
        }

        function switchTab(tab) {
            document.getElementById('panel-prompts').classList.add('hidden');
            document.getElementById('panel-history').classList.add('hidden');
            document.getElementById('tab-prompts').className = "flex-1 py-2 text-sm font-semibold text-gray-400 hover:bg-gray-700";
            document.getElementById('tab-history').className = "flex-1 py-2 text-sm font-semibold text-gray-400 hover:bg-gray-700";

            document.getElementById(`panel-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = "flex-1 py-2 text-sm font-semibold bg-gray-700 text-blue-400";
        }
    </script>
</body>
</html>